<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYTOA - The Official Agency Portal</title>
    <style>
        :root {
            --toa-black: #1a1a1a;
            --toa-dark: #2d2d2d;
            --toa-gray: #6b6b6b;
            --toa-light: #f5f5f0;
            --toa-accent: #c8e64e;
            --toa-accent-dark: #a8c42e;
            --toa-white: #ffffff;
            --toa-border: #e0e0d8;
            --radius: 12px;
            --shadow: 0 2px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--toa-light);
            color: var(--toa-black);
            min-height: 100vh;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--toa-black);
        }

        .login-card {
            background: var(--toa-white);
            border-radius: var(--radius);
            padding: 48px 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .login-card .logo {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: 3px;
            color: var(--toa-black);
            margin-bottom: 8px;
        }

        .login-card .subtitle {
            color: var(--toa-gray);
            font-size: 14px;
            margin-bottom: 32px;
        }

        .login-card input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--toa-border);
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
            outline: none;
        }

        .login-card input:focus {
            border-color: var(--toa-accent);
        }

        .login-card button {
            width: 100%;
            padding: 14px;
            background: var(--toa-black);
            color: var(--toa-white);
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 4px;
        }

        .login-card button:hover {
            background: var(--toa-dark);
        }

        .login-card button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .login-error {
            color: #d32f2f;
            font-size: 13px;
            margin-top: 12px;
            min-height: 20px;
        }

        /* --- MY MEETINGS --- */
        .meetings-services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .service-card {
            background: var(--toa-white);
            border: 1px solid var(--toa-border);
            border-radius: var(--radius);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            transition: all 0.2s;
        }

        .service-card:not(.service-coming-soon):hover {
            box-shadow: var(--shadow);
        }

        .service-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-card-header h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .service-icon {
            width: 40px;
            height: 40px;
            background: var(--toa-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .service-status {
            font-size: 12px;
            color: var(--toa-gray);
        }

        .service-status.connected {
            color: #2e7d32;
            font-weight: 600;
        }

        .btn-service-connect {
            padding: 8px 18px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            background: var(--toa-black);
            color: var(--toa-white);
            border: none;
        }

        .btn-service-connect:hover:not(:disabled) {
            background: var(--toa-dark);
        }

        .btn-service-connect:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: var(--toa-gray);
        }

        .btn-service-connect.connected {
            background: transparent;
            border: 1px solid #e57373;
            color: #d32f2f;
        }

        .btn-service-connect.connected:hover {
            background: #ffebee;
        }

        .service-coming-soon {
            opacity: 0.6;
        }

        .meetings-action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .source-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .source-badge.google-meet { background: #e0f2f1; color: #00695c; }
        .source-badge.manual { background: var(--toa-light); color: var(--toa-gray); }
        .source-badge.fyxer { background: #e8eaf6; color: #283593; }
        .source-badge.plaud { background: #fce4ec; color: #c62828; }

        /* --- MFA SCREEN --- */
        #mfa-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--toa-black);
        }

        /* --- PORTAL --- */
        #portal {
            display: none;
        }

        /* Header */
        .portal-header {
            background: var(--toa-black);
            color: var(--toa-white);
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .portal-header .logo {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .portal-header .logo span {
            color: var(--toa-accent);
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-badge {
            font-size: 13px;
            color: var(--toa-gray);
        }

        .btn-change-pw {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--toa-accent);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-change-pw:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--toa-accent);
        }

        .btn-logout {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--toa-white);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.4);
        }

        /* Navigation tabs */
        .portal-nav {
            background: var(--toa-white);
            border-bottom: 1px solid var(--toa-border);
            padding: 0 32px;
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--toa-gray);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
        }

        .nav-tab:hover {
            color: var(--toa-black);
        }

        .nav-tab.active {
            color: var(--toa-black);
            border-bottom-color: var(--toa-accent);
            font-weight: 600;
        }

        /* Content area */
        .portal-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Section title */
        .section-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .section-desc {
            color: var(--toa-gray);
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* --- FORMS SECTION --- */
        .forms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
        }

        .form-card {
            background: var(--toa-white);
            border: 1px solid var(--toa-border);
            border-radius: var(--radius);
            padding: 28px 24px;
            transition: all 0.2s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .form-card:hover {
            box-shadow: var(--shadow);
            border-color: var(--toa-accent);
            transform: translateY(-2px);
        }

        .form-card .form-icon {
            width: 44px;
            height: 44px;
            background: var(--toa-light);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 16px;
        }

        .form-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .form-card p {
            font-size: 13px;
            color: var(--toa-gray);
            line-height: 1.5;
        }

        /* --- EMBED SECTIONS --- */
        .embed-container {
            background: var(--toa-white);
            border: 1px solid var(--toa-border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .embed-container iframe {
            width: 100%;
            border: none;
            min-height: 600px;
        }

        /* --- EMPLOYEE / SIGNATURES SECTION --- */
        .employee-selector {
            background: var(--toa-white);
            border: 1px solid var(--toa-border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
        }

        .employee-selector label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .employee-selector select {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            border: 2px solid var(--toa-border);
            border-radius: 8px;
            font-size: 15px;
            outline: none;
            cursor: pointer;
            background: var(--toa-white);
            transition: border-color 0.2s;
        }

        .employee-selector select:focus {
            border-color: var(--toa-accent);
        }

        .employee-detail {
            display: none;
        }

        .employee-detail.active {
            display: block;
        }

        .employee-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-card {
            background: var(--toa-white);
            border: 1px solid var(--toa-border);
            border-radius: var(--radius);
            padding: 20px;
        }

        .info-card .info-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--toa-gray);
            margin-bottom: 6px;
        }

        .info-card .info-value {
            font-size: 15px;
            font-weight: 500;
            word-break: break-all;
        }

        .info-card .info-value a {
            color: var(--toa-black);
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        /* Signature preview */
        .signature-section {
            background: var(--toa-white);
            border: 1px solid var(--toa-border);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .signature-section-header {
            padding: 16px 20px;
            font-weight: 600;
            font-size: 14px;
            border-bottom: 1px solid var(--toa-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .signature-preview {
            padding: 24px;
            background: #fafafa;
        }

        .signature-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-copy {
            background: var(--toa-black);
            color: var(--toa-white);
            border: none;
        }

        .btn-copy:hover {
            background: var(--toa-dark);
        }

        .btn-preview {
            background: transparent;
            border: 1px solid var(--toa-border);
            color: var(--toa-black);
        }

        .btn-preview:hover {
            background: var(--toa-light);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--toa-black);
            color: var(--toa-white);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Loading spinner */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 48px;
            color: var(--toa-gray);
            font-size: 14px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--toa-border);
            border-top-color: var(--toa-black);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- ADMIN SECTION --- */
        .admin-section {
            background: var(--toa-white);
            border: 1px solid var(--toa-border);
            border-radius: var(--radius);
            padding: 28px 24px;
            margin-bottom: 24px;
        }

        .admin-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .admin-form-group {
            margin-bottom: 16px;
        }

        .admin-form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--toa-dark);
        }

        .admin-form-group input,
        .admin-form-group select {
            width: 100%;
            max-width: 400px;
            padding: 10px 14px;
            border: 2px solid var(--toa-border);
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .admin-form-group input:focus,
        .admin-form-group select:focus {
            border-color: var(--toa-accent);
        }

        .admin-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .admin-checks {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        .admin-checks label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 400;
            font-size: 14px;
            cursor: pointer;
        }

        .admin-checks input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--toa-accent-dark);
        }

        .btn-create {
            padding: 12px 28px;
            background: var(--toa-black);
            color: var(--toa-white);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 8px;
        }

        .btn-create:hover {
            background: var(--toa-dark);
        }

        .btn-create:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Admin users table */
        .admin-table-wrap {
            overflow-x: auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .admin-table th {
            text-align: left;
            padding: 12px 10px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--toa-gray);
            border-bottom: 2px solid var(--toa-border);
            white-space: nowrap;
        }

        .admin-table td {
            padding: 12px 10px;
            border-bottom: 1px solid var(--toa-border);
            vertical-align: middle;
        }

        .admin-table tr:last-child td {
            border-bottom: none;
        }

        .role-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .role-badge.admin {
            background: var(--toa-accent);
            color: var(--toa-black);
        }

        .role-badge.user {
            background: var(--toa-light);
            color: var(--toa-gray);
        }

        .perm-check {
            color: var(--toa-accent-dark);
            font-weight: 700;
            font-size: 16px;
        }

        .perm-cross {
            color: var(--toa-border);
            font-size: 14px;
        }

        .btn-edit {
            padding: 5px 12px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            background: var(--toa-light);
            border: 1px solid var(--toa-border);
            color: var(--toa-black);
            font-weight: 500;
            transition: all 0.2s;
            margin-right: 4px;
        }

        .btn-edit:hover {
            background: var(--toa-accent);
            border-color: var(--toa-accent);
        }

        .btn-delete {
            padding: 5px 12px;
            font-size: 12px;
            border-radius: 6px;
            cursor: pointer;
            background: transparent;
            border: 1px solid #e57373;
            color: #d32f2f;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: #ffebee;
        }

        /* --- MODALS --- */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-card {
            background: var(--toa-white);
            border-radius: var(--radius);
            width: 100%;
            max-width: 480px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .modal-header {
            background: var(--toa-black);
            color: var(--toa-white);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--toa-white);
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
            padding: 0 4px;
        }

        .modal-close:hover {
            color: var(--toa-accent);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-modal-cancel {
            padding: 10px 20px;
            background: transparent;
            border: 1px solid var(--toa-border);
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            color: var(--toa-gray);
            transition: all 0.2s;
        }

        .btn-modal-cancel:hover {
            background: var(--toa-light);
        }

        .btn-modal-save {
            padding: 10px 20px;
            background: var(--toa-black);
            color: var(--toa-white);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-modal-save:hover {
            background: var(--toa-dark);
        }

        .btn-modal-save:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .portal-content { padding: 20px 16px; }
            .portal-header { padding: 0 16px; }
            .portal-nav { padding: 0 16px; }
            .nav-tab { padding: 14px 16px; font-size: 13px; }
            .employee-info-grid { grid-template-columns: 1fr; }
            .forms-grid { grid-template-columns: 1fr; }
            .login-card { margin: 16px; padding: 32px 24px; }
            .admin-form-row { grid-template-columns: 1fr; }
            .admin-checks { flex-direction: column; gap: 10px; }
            .modal-card { margin: 16px; }
        }

        /* --- USER CREATED SUCCESS MODAL --- */
        .success-modal-body {
            text-align: center;
            padding: 32px 24px;
        }
        .success-modal-body .success-icon {
            width: 56px; height: 56px;
            background: var(--toa-accent);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px;
            margin: 0 auto 16px;
        }
        .success-modal-body h4 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .success-modal-body p { font-size: 14px; color: var(--toa-gray); margin-bottom: 24px; line-height: 1.5; }
        .success-actions { display: flex; flex-direction: column; gap: 12px; }
        .btn-success-action {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 14px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; border: none; width: 100%;
        }
        .btn-send-email { background: var(--toa-black); color: var(--toa-white); }
        .btn-send-email:hover { background: var(--toa-dark); }
        .btn-send-email:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-send-whatsapp { background: #25D366; color: var(--toa-white); }
        .btn-send-whatsapp:hover { background: #1da851; }
        .btn-success-done {
            background: transparent; border: 1px solid var(--toa-border); color: var(--toa-gray);
            padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; margin-top: 8px;
        }
        .btn-success-done:hover { background: var(--toa-light); }
        .admin-form-hint { color: var(--toa-gray); font-size: 12px; margin-top: 4px; display: block; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/otpauth@9/dist/otpauth.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1/build/qrcode.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<!-- ======= LOGIN SCREEN ======= -->
<div id="login-screen">
    <div class="login-card">
        <div class="logo">MYTOA</div>
        <div class="subtitle">The Official Agency - Internal Portal</div>
        <form id="login-form">
            <input type="email" id="username" placeholder="Email address" autocomplete="username" required>
            <input type="password" id="password" placeholder="Password" autocomplete="current-password" required>
            <button type="submit" id="login-btn">Sign In</button>
        </form>
        <div class="login-error" id="login-error"></div>
    </div>
</div>

<!-- ======= MFA VERIFICATION SCREEN ======= -->
<div id="mfa-screen" style="display:none;">
    <div class="login-card">
        <div class="logo">MYTOA</div>
        <div class="subtitle">Two-Factor Authentication</div>
        <p style="font-size:14px; color:var(--toa-gray); margin-bottom:20px;">
            Enter the 6-digit code from your authenticator app.
        </p>
        <form id="mfa-form">
            <input type="text" id="mfa-code" placeholder="000000"
                   maxlength="6" pattern="[0-9]{6}" inputmode="numeric"
                   autocomplete="one-time-code" required
                   style="text-align:center; font-size:24px; letter-spacing:8px; font-weight:600;">
            <button type="submit" id="mfa-btn">Verify</button>
        </form>
        <div class="login-error" id="mfa-error"></div>
        <button onclick="cancelMfa()" style="background:none; border:none; color:var(--toa-gray); font-size:13px; cursor:pointer; margin-top:16px; text-decoration:underline;">
            Back to sign in
        </button>
    </div>
</div>

<!-- ======= PORTAL ======= -->
<div id="portal">

    <!-- Header -->
    <header class="portal-header">
        <div class="logo">
            MYTOA
            <span>Portal</span>
        </div>
        <div class="header-actions">
            <span class="user-badge" id="user-badge"></span>
            <button class="btn-change-pw" onclick="openChangePasswordModal()">Change Password</button>
            <button class="btn-change-pw" id="btn-mfa-header" onclick="openMfaSettings()" style="display:none;">Set Up MFA</button>
            <button class="btn-logout" onclick="logout()">Sign Out</button>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="portal-nav">
        <button class="nav-tab active" data-tab="forms">Forms</button>
        <button class="nav-tab" data-tab="team">Team & Signatures</button>
        <button class="nav-tab" data-tab="forecast">Forecast Dashboard</button>
        <button class="nav-tab" data-tab="runway">Runway</button>
        <button class="nav-tab" data-tab="clients">Client Database</button>
        <button class="nav-tab" data-tab="meetings">My Meetings</button>
        <button class="nav-tab" data-tab="admin" style="display:none;">Admin</button>
    </nav>

    <!-- Content -->
    <main class="portal-content">

        <!-- -- FORMS TAB -- -->
        <div class="tab-content active" id="tab-forms">
            <h2 class="section-title">Airtable Forms</h2>
            <p class="section-desc">Quick access to all input forms. Each form opens in a new tab.</p>
            <div class="forms-grid">
                <a class="form-card" href="https://airtable.com/appI6JW9tMk59HgFp/pagdKAoE3naGPPCRH/form" target="_blank" rel="noopener">
                    <div class="form-icon">&#128188;</div>
                    <h3>New Client Entry</h3>
                    <p>Register a new client in the database with all relevant details.</p>
                </a>
                <a class="form-card" href="https://airtable.com/appI6JW9tMk59HgFp/pagfk7u6bgWXE5SsU/form" target="_blank" rel="noopener">
                    <div class="form-icon">&#128203;</div>
                    <h3>Project Entry</h3>
                    <p>Create a new project entry linked to clients and team members.</p>
                </a>
                <a class="form-card" href="https://airtable.com/appI6JW9tMk59HgFp/pagVI0BrH0qKZybe2/form" target="_blank" rel="noopener">
                    <div class="form-icon">&#129309;</div>
                    <h3>New Freelancers & Suppliers</h3>
                    <p>Add freelancers and suppliers to the contact database.</p>
                </a>
                <a class="form-card" href="https://airtable.com/appI6JW9tMk59HgFp/pagw2K0L5jWz0Du2a/form" target="_blank" rel="noopener">
                    <div class="form-icon">&#127881;</div>
                    <h3>Welcome to TOA</h3>
                    <p>Onboarding form for new team members joining The Official Agency.</p>
                </a>
            </div>
        </div>

        <!-- -- TEAM & SIGNATURES TAB -- -->
        <div class="tab-content" id="tab-team">
            <h2 class="section-title">Team & Signatures</h2>
            <p class="section-desc">Select a team member to view their details and email signature.</p>

            <div class="employee-selector">
                <label for="employee-select">Select team member</label>
                <select id="employee-select">
                    <option value="">Choose a person...</option>
                </select>
            </div>

            <div id="employee-loading" class="loading" style="display:none;">
                <div class="spinner"></div>
                Loading team data...
            </div>

            <div id="employee-detail" class="employee-detail">
                <div class="employee-info-grid" id="employee-info-grid">
                    <!-- Filled dynamically -->
                </div>

                <div class="signature-section" id="signature-section" style="display:none;">
                    <div class="signature-section-header">
                        <span>Email Signature</span>
                        <div class="signature-actions">
                            <button class="btn-sm btn-copy" onclick="copySignature()">Copy HTML</button>
                            <a class="btn-sm btn-preview" id="sig-preview-link" href="#" target="_blank" rel="noopener">Open Preview</a>
                        </div>
                    </div>
                    <div class="signature-preview" id="signature-preview">
                        <!-- Filled dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- -- FORECAST DASHBOARD TAB -- -->
        <div class="tab-content" id="tab-forecast">
            <h2 class="section-title">Forecast Dashboard</h2>
            <p class="section-desc">Forecast metrics overview with burn rate, project costs, invoices, and financial data.</p>
            <div class="embed-container">
                <iframe
                    src="https://airtable.com/embed/appI6JW9tMk59HgFp/shr0zHmboZ8Dz7xv8"
                    loading="lazy"
                    style="min-height: 700px;"
                ></iframe>
            </div>
        </div>

        <!-- -- RUNWAY TAB -- -->
        <div class="tab-content" id="tab-runway">
            <h2 class="section-title">Runway Overview</h2>
            <p class="section-desc">Long-term and short-term runway metrics from the forecast history.</p>
            <div class="embed-container">
                <iframe
                    src="https://airtable.com/embed/appI6JW9tMk59HgFp/shrLFPb1fIc4PuIHS"
                    loading="lazy"
                    style="min-height: 600px;"
                ></iframe>
            </div>
        </div>

        <!-- -- CLIENT DATABASE TAB -- -->
        <div class="tab-content" id="tab-clients">
            <h2 class="section-title">Client Database</h2>
            <p class="section-desc">Browse the full client list with contacts and account managers.</p>
            <div class="embed-container">
                <iframe
                    src="https://airtable.com/embed/appI6JW9tMk59HgFp/shrELxcqCWD4JUXds"
                    loading="lazy"
                    style="min-height: 700px;"
                ></iframe>
            </div>
        </div>

        <!-- -- MY MEETINGS TAB -- -->
        <div class="tab-content" id="tab-meetings">
            <h2 class="section-title">My Meetings</h2>
            <p class="section-desc">View your meeting transcripts and connect services to auto-import them.</p>

            <!-- Connected Services -->
            <div class="meetings-services-grid">
                <div class="service-card" id="service-google-meet">
                    <div class="service-card-header">
                        <div class="service-icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z" fill="#00897B"/>
                                <path d="M15.5 8.5l-3 2.5V8.5H7.5v7h5V13l3 2.5v-7z" fill="white"/>
                            </svg>
                        </div>
                        <div>
                            <h4>Google Meet</h4>
                            <p class="service-status" id="google-meet-status">Not connected</p>
                        </div>
                    </div>
                    <button class="btn-service-connect" id="btn-connect-google" onclick="connectGoogleMeet()">Connect</button>
                </div>

                <div class="service-card service-coming-soon">
                    <div class="service-card-header">
                        <div class="service-icon">
                            <span style="font-size:20px;">&#129302;</span>
                        </div>
                        <div>
                            <h4>Fyxer.ai</h4>
                            <p class="service-status">Coming Soon</p>
                        </div>
                    </div>
                    <button class="btn-service-connect" disabled>Coming Soon</button>
                </div>

                <div class="service-card service-coming-soon">
                    <div class="service-card-header">
                        <div class="service-icon">
                            <span style="font-size:20px;">&#127908;</span>
                        </div>
                        <div>
                            <h4>Plaud</h4>
                            <p class="service-status">Coming Soon</p>
                        </div>
                    </div>
                    <button class="btn-service-connect" disabled>Coming Soon</button>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="meetings-action-bar">
                <button class="btn-create" onclick="openUploadTranscriptModal()">&#128196; Upload Transcript</button>
                <button class="btn-create" id="btn-sync-google" onclick="syncGoogleMeetTranscripts()" style="display:none;">&#128260; Sync from Google Meet</button>
            </div>

            <!-- Loading -->
            <div id="meetings-loading" class="loading" style="display:none;">
                <div class="spinner"></div>
                Loading meetings...
            </div>

            <!-- Empty State -->
            <div id="meetings-empty" style="display:none; text-align:center; padding:48px 24px; color:var(--toa-gray);">
                <div style="font-size:48px; margin-bottom:16px;">&#128466;</div>
                <h3 style="font-size:18px; font-weight:600; margin-bottom:8px; color:var(--toa-black);">No meetings yet</h3>
                <p style="font-size:14px; line-height:1.6;">
                    Connect Google Meet to import transcripts automatically,<br>or upload a transcript manually.
                </p>
            </div>

            <!-- Meetings Table -->
            <div class="admin-section" id="meetings-table-section" style="display:none;">
                <div class="admin-table-wrap">
                    <table class="admin-table" id="meetings-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Title</th>
                                <th>Source</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="meetings-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- -- ADMIN TAB -- -->
        <div class="tab-content" id="tab-admin">
            <h2 class="section-title">Admin Panel</h2>
            <p class="section-desc">Manage portal users, roles, and permissions.</p>

            <!-- Create New User -->
            <div class="admin-section">
                <h3>Create New User</h3>
                <div class="admin-form-row">
                    <div class="admin-form-group">
                        <label>Display Name</label>
                        <input type="text" id="new-displayname" placeholder="Enter display name">
                    </div>
                    <div class="admin-form-group">
                        <label>Mobile Number</label>
                        <input type="tel" id="new-mobile" placeholder="+31612345678">
                        <small class="admin-form-hint">International format with country code</small>
                    </div>
                </div>
                <div class="admin-form-row">
                    <div class="admin-form-group">
                        <label>Email Address</label>
                        <input type="email" id="new-username" placeholder="Enter email address">
                    </div>
                    <div class="admin-form-group">
                        <label>Password</label>
                        <input type="password" id="new-password" placeholder="Min 4 characters">
                    </div>
                </div>
                <div class="admin-form-group">
                    <label>Role</label>
                    <select id="new-role">
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
                <div class="admin-form-group">
                    <label>Permissions</label>
                    <div class="admin-checks">
                        <label><input type="checkbox" id="new-allow-forms" checked> Allow Forms</label>
                        <label><input type="checkbox" id="new-allow-team" checked> Allow Team</label>
                        <label><input type="checkbox" id="new-allow-forecast"> Allow Forecast</label>
                        <label><input type="checkbox" id="new-allow-runway"> Allow Runway</label>
                        <label><input type="checkbox" id="new-allow-clients"> Allow Clients</label>
                    </div>
                </div>
                <button class="btn-create" id="btn-create-user" onclick="createUser()">Create User</button>
            </div>

            <!-- Portal Users Table -->
            <div class="admin-section">
                <h3>Portal Users</h3>
                <div id="admin-users-loading" class="loading" style="display:none;">
                    <div class="spinner"></div>
                    Loading users...
                </div>
                <div class="admin-table-wrap">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Mobile</th>
                                <th>Role</th>
                                <th>Forms</th>
                                <th>Team</th>
                                <th>Forecast</th>
                                <th>Runway</th>
                                <th>Clients</th>
                                <th>MFA</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- ======= EDIT USER MODAL ======= -->
<div class="modal-overlay" id="modal-edit-user">
    <div class="modal-card">
        <div class="modal-header">
            <h3>Edit User</h3>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-record-id">
            <div class="admin-form-group">
                <label>Email Address</label>
                <input type="email" id="edit-username" readonly style="background:#f5f5f0; color:#6b6b6b;">
            </div>
            <div class="admin-form-row">
                <div class="admin-form-group">
                    <label>Display Name</label>
                    <input type="text" id="edit-displayname" placeholder="Enter display name">
                </div>
                <div class="admin-form-group">
                    <label>Mobile Number</label>
                    <input type="tel" id="edit-mobile" placeholder="+31612345678">
                </div>
            </div>
            <div class="admin-form-group">
                <label>New Password <span style="font-weight:400;color:#6b6b6b;">(leave blank to keep current)</span></label>
                <input type="password" id="edit-password" placeholder="Enter new password">
            </div>
            <div class="admin-form-group">
                <label>Role</label>
                <select id="edit-role">
                    <option value="User">User</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>
            <div class="admin-form-group">
                <label>Permissions</label>
                <div class="admin-checks">
                    <label><input type="checkbox" id="edit-allow-forms"> Allow Forms</label>
                    <label><input type="checkbox" id="edit-allow-team"> Allow Team</label>
                    <label><input type="checkbox" id="edit-allow-forecast"> Allow Forecast</label>
                    <label><input type="checkbox" id="edit-allow-runway"> Allow Runway</label>
                    <label><input type="checkbox" id="edit-allow-clients"> Allow Clients</label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="btn-modal-save" id="btn-save-edit" onclick="saveEditUser()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- ======= CHANGE PASSWORD MODAL ======= -->
<div class="modal-overlay" id="modal-change-pw">
    <div class="modal-card">
        <div class="modal-header">
            <h3>Change Password</h3>
            <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="admin-form-group">
                <label for="pw-current">Current Password</label>
                <input type="password" id="pw-current" placeholder="Enter current password">
            </div>
            <div class="admin-form-group">
                <label for="pw-new">New Password</label>
                <input type="password" id="pw-new" placeholder="Min 4 characters">
            </div>
            <div class="admin-form-group">
                <label for="pw-confirm">Confirm New Password</label>
                <input type="password" id="pw-confirm" placeholder="Re-enter new password">
            </div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="closeChangePasswordModal()">Cancel</button>
                <button class="btn-modal-save" id="btn-save-pw" onclick="saveChangePassword()">Update Password</button>
            </div>
        </div>
    </div>
</div>

<!-- ======= USER CREATED SUCCESS MODAL ======= -->
<div class="modal-overlay" id="modal-user-created">
    <div class="modal-card">
        <div class="modal-header">
            <h3>User Created</h3>
            <button class="modal-close" onclick="closeUserCreatedModal()">&times;</button>
        </div>
        <div class="success-modal-body">
            <div class="success-icon">&#10003;</div>
            <h4 id="created-user-name"></h4>
            <p id="created-user-info"></p>
            <div class="success-actions">
                <button class="btn-success-action btn-send-email" id="btn-send-welcome-email" onclick="sendWelcomeEmail()">
                    &#9993; Send Welcome Email
                </button>
                <button class="btn-success-action btn-send-whatsapp" id="btn-send-whatsapp" onclick="sendWhatsAppPassword()">
                    &#128172; Send Password via WhatsApp
                </button>
            </div>
            <button class="btn-success-done" onclick="closeUserCreatedModal()">Done</button>
        </div>
    </div>
</div>

<!-- ======= MFA SETUP MODAL ======= -->
<div class="modal-overlay" id="modal-mfa-setup">
    <div class="modal-card" style="max-width:420px;">
        <div class="modal-header">
            <h3>Set Up Two-Factor Authentication</h3>
            <button class="modal-close" onclick="closeMfaSetupModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:24px;">
            <!-- Step 1: Show QR code -->
            <div id="mfa-setup-step1">
                <p style="font-size:14px; color:var(--toa-gray); margin-bottom:16px;">
                    Scan this QR code with your authenticator app (1Password, Google Authenticator, etc.).
                </p>
                <div id="mfa-qr-container" style="text-align:center; margin:20px 0;">
                    <canvas id="mfa-qr-canvas"></canvas>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-size:12px; color:var(--toa-gray); display:block; margin-bottom:4px;">
                        Or enter this key manually:
                    </label>
                    <code id="mfa-secret-display" style="display:block; background:var(--toa-light); padding:10px; border-radius:6px; font-size:14px; letter-spacing:2px; word-break:break-all; text-align:center; user-select:all;"></code>
                </div>
                <p style="font-size:14px; color:var(--toa-gray); margin-bottom:12px;">
                    Enter the 6-digit code shown in your app to verify:
                </p>
                <input type="text" id="mfa-setup-code" placeholder="000000"
                       maxlength="6" pattern="[0-9]{6}" inputmode="numeric"
                       style="text-align:center; font-size:20px; letter-spacing:6px; font-weight:600; width:100%; padding:14px 16px; border:2px solid var(--toa-border); border-radius:8px; outline:none;">
                <div id="mfa-setup-error" style="color:#d32f2f; font-size:13px; margin-top:8px; min-height:20px;"></div>
                <div class="modal-actions">
                    <button class="btn-modal-cancel" onclick="closeMfaSetupModal()">Cancel</button>
                    <button class="btn-modal-save" id="btn-verify-mfa-setup" onclick="verifyMfaSetup()">Enable MFA</button>
                </div>
            </div>
            <!-- Step 2: Success -->
            <div id="mfa-setup-step2" style="display:none; text-align:center; padding:20px 0;">
                <div style="width:56px; height:56px; background:var(--toa-accent); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px; font-size:28px;">&#10003;</div>
                <h4 style="font-size:18px; font-weight:600; margin-bottom:8px;">MFA Enabled</h4>
                <p style="font-size:14px; color:var(--toa-gray); margin-bottom:20px;">
                    Two-factor authentication is now active on your account.
                </p>
                <button class="btn-modal-save" onclick="closeMfaSetupModal()">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- ======= MFA DISABLE MODAL ======= -->
<div class="modal-overlay" id="modal-mfa-disable">
    <div class="modal-card" style="max-width:400px;">
        <div class="modal-header">
            <h3>Disable Two-Factor Authentication</h3>
            <button class="modal-close" onclick="closeMfaDisableModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:24px;">
            <p style="font-size:14px; color:var(--toa-gray); margin-bottom:16px;">
                Enter your current 6-digit code to confirm you want to disable MFA.
            </p>
            <input type="text" id="mfa-disable-code" placeholder="000000"
                   maxlength="6" pattern="[0-9]{6}" inputmode="numeric"
                   style="text-align:center; font-size:20px; letter-spacing:6px; font-weight:600; width:100%; padding:14px 16px; border:2px solid var(--toa-border); border-radius:8px; outline:none;">
            <div id="mfa-disable-error" style="color:#d32f2f; font-size:13px; margin-top:8px; min-height:20px;"></div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="closeMfaDisableModal()">Cancel</button>
                <button class="btn-modal-save" id="btn-confirm-disable-mfa" onclick="confirmDisableMfa()" style="background:#d32f2f;">Disable MFA</button>
            </div>
        </div>
    </div>
</div>

<!-- ======= UPLOAD TRANSCRIPT MODAL ======= -->
<div class="modal-overlay" id="modal-upload-transcript">
    <div class="modal-card" style="max-width:560px;">
        <div class="modal-header">
            <h3>Upload Transcript</h3>
            <button class="modal-close" onclick="closeUploadTranscriptModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding:24px;">
            <div class="admin-form-group">
                <label for="transcript-title">Meeting Title</label>
                <input type="text" id="transcript-title" placeholder="e.g., Weekly standup with client" style="max-width:100%;">
            </div>
            <div class="admin-form-row">
                <div class="admin-form-group">
                    <label for="transcript-date">Meeting Date</label>
                    <input type="date" id="transcript-date" style="max-width:100%;">
                </div>
                <div class="admin-form-group">
                    <label for="transcript-duration">Duration (optional)</label>
                    <input type="text" id="transcript-duration" placeholder="e.g., 45 min" style="max-width:100%;">
                </div>
            </div>
            <div class="admin-form-group">
                <label for="transcript-participants">Participants (optional)</label>
                <input type="text" id="transcript-participants" placeholder="e.g., Alice, Bob, Charlie" style="max-width:100%;">
            </div>
            <div class="admin-form-group">
                <label for="transcript-content">Transcript Content</label>
                <textarea id="transcript-content" rows="10" placeholder="Paste the full transcript here..."
                    style="width:100%; padding:12px 14px; border:2px solid var(--toa-border); border-radius:8px; font-size:14px; font-family:inherit; outline:none; resize:vertical; transition:border-color 0.2s;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="closeUploadTranscriptModal()">Cancel</button>
                <button class="btn-modal-save" id="btn-save-transcript" onclick="saveManualTranscript()">Save Transcript</button>
            </div>
        </div>
    </div>
</div>

<!-- ======= VIEW TRANSCRIPT MODAL ======= -->
<div class="modal-overlay" id="modal-view-transcript">
    <div class="modal-card" style="max-width:700px; max-height:80vh; display:flex; flex-direction:column;">
        <div class="modal-header">
            <h3 id="view-transcript-title">Transcript</h3>
            <button class="modal-close" onclick="closeViewTranscriptModal()">&times;</button>
        </div>
        <div class="modal-body" style="overflow-y:auto; flex:1; padding:24px;">
            <div style="display:flex; gap:16px; margin-bottom:16px; flex-wrap:wrap;">
                <div class="info-card" style="flex:1; min-width:120px;">
                    <div class="info-label">Date</div>
                    <div class="info-value" id="view-transcript-date"></div>
                </div>
                <div class="info-card" style="flex:1; min-width:120px;">
                    <div class="info-label">Source</div>
                    <div class="info-value" id="view-transcript-source"></div>
                </div>
                <div class="info-card" style="flex:1; min-width:120px;">
                    <div class="info-label">Duration</div>
                    <div class="info-value" id="view-transcript-duration"></div>
                </div>
            </div>
            <div id="view-transcript-participants-section" style="display:none; margin-bottom:16px;">
                <div class="info-card">
                    <div class="info-label">Participants</div>
                    <div class="info-value" id="view-transcript-participants-value"></div>
                </div>
            </div>
            <div style="background:var(--toa-light); border:1px solid var(--toa-border); border-radius:8px; padding:20px;">
                <pre id="view-transcript-content" style="white-space:pre-wrap; word-wrap:break-word; font-family:inherit; font-size:14px; line-height:1.7; margin:0; color:var(--toa-black);"></pre>
            </div>
            <div class="modal-actions">
                <button class="btn-modal-cancel" onclick="closeViewTranscriptModal()">Close</button>
                <button class="btn-modal-save" onclick="copyTranscriptContent()">Copy Transcript</button>
            </div>
        </div>
    </div>
</div>

<script>
/* =======================================
   CONFIGURATION
   ======================================= */
const CONFIG = {
    AIRTABLE_TOKEN: 'pat1kPT1w7gECO8vm.dc0d4c28fb7a9ff0e69820eafc80bddce0bfdd0426ff40e411649b72fed6105e',
    BASE_ID: 'appI6JW9tMk59HgFp',
    USERS_TABLE: 'tblb8yJFXlHlmV9cQ',
    SIGNATURES_TABLE: 'tblwUME91QcUDVkMk',
    EMAILJS_PUBLIC_KEY: 'KTD5rjhJHxpLLzazD',
    EMAILJS_SERVICE_ID: 'service_2e84owl',
    EMAILJS_TEMPLATE_ID: 'template_07w1vld',
    PORTAL_URL: 'https://toatools.github.io/portal/',
    MEETINGS_TABLE: '',  // Add Airtable table ID after creating "Meeting Transcripts" table
    GOOGLE_CLIENT_ID: '',  // Add Google OAuth Client ID after creating Google Cloud project
};

const API = `https://api.airtable.com/v0/${CONFIG.BASE_ID}`;
const headers = { 'Authorization': `Bearer ${CONFIG.AIRTABLE_TOKEN}` };
const writeHeaders = { 'Authorization': `Bearer ${CONFIG.AIRTABLE_TOKEN}`, 'Content-Type': 'application/json' };

let lastCreatedUser = null;
let pendingMfaUser = null;
let meetingsData = [];
let googleAccessToken = sessionStorage.getItem('toa_google_token') || null;

// Initialize EmailJS (if configured)
if (CONFIG.EMAILJS_PUBLIC_KEY && typeof emailjs !== 'undefined') {
    emailjs.init(CONFIG.EMAILJS_PUBLIC_KEY);
}

/* =======================================
   SESSION HELPERS
   ======================================= */
function getCurrentSession() {
    try {
        const raw = sessionStorage.getItem('toa_session');
        return raw ? JSON.parse(raw) : null;
    } catch (e) {
        return null;
    }
}

/* =======================================
   AUTHENTICATION
   ======================================= */
function buildSession(rec) {
    const f = rec.fields;
    return {
        username: f['Username'] || '',
        displayName: f['Display Name'] || '',
        recordId: rec.id,
        role: f['Role'] || 'User',
        mfaEnabled: !!(f['MFA Secret']),
        permissions: {
            forms: !!f['Allow Forms'],
            team: !!f['Allow Team'],
            forecast: !!f['Allow Forecast'],
            runway: !!f['Allow Runway'],
            clients: !!f['Allow Clients'],
        }
    };
}

document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('login-btn');
    const errorEl = document.getElementById('login-error');
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    btn.disabled = true;
    btn.textContent = 'Signing in...';
    errorEl.textContent = '';

    try {
        const filter = encodeURIComponent(`AND({Username}="${username}",{Password}="${password}")`);
        const res = await fetch(`${API}/${CONFIG.USERS_TABLE}?filterByFormula=${filter}`, { headers });
        const data = await res.json();

        if (data.records && data.records.length > 0) {
            const rec = data.records[0];
            const mfaSecret = rec.fields['MFA Secret'] || '';

            if (mfaSecret) {
                // MFA enabled  park user and show verification screen
                pendingMfaUser = { record: rec, secret: mfaSecret };
                showMfaVerification();
            } else {
                // No MFA  proceed as before
                const session = buildSession(rec);
                sessionStorage.setItem('toa_session', JSON.stringify(session));
                showPortal(session);
            }
        } else {
            errorEl.textContent = 'Invalid email address or password.';
        }
    } catch (err) {
        errorEl.textContent = 'Connection error. Please try again.';
        console.error(err);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
    }
});

function showPortal(session) {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('mfa-screen').style.display = 'none';
    document.getElementById('portal').style.display = 'block';
    document.getElementById('user-badge').textContent = `Signed in as ${session.displayName || session.username}`;

    const isAdmin = session.role === 'Admin';

    // Tab permission map
    const tabPermMap = {
        forms: session.permissions.forms,
        team: session.permissions.team,
        forecast: session.permissions.forecast,
        runway: session.permissions.runway,
        clients: session.permissions.clients,
        admin: isAdmin,
    };

    // Show/hide nav tabs based on permissions
    const navTabs = document.querySelectorAll('.nav-tab');
    navTabs.forEach(tab => {
        const tabKey = tab.dataset.tab;
        if (tabKey === 'admin') {
            tab.style.display = isAdmin ? '' : 'none';
        } else if (tabKey === 'meetings') {
            tab.style.display = ''; // Always visible to all users
        } else {
            tab.style.display = (isAdmin || tabPermMap[tabKey]) ? '' : 'none';
        }
    });

    // Activate first visible tab
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    const firstVisible = Array.from(navTabs).find(t => t.style.display !== 'none');
    if (firstVisible) {
        firstVisible.classList.add('active');
        document.getElementById('tab-' + firstVisible.dataset.tab).classList.add('active');
    }

    loadSignatures();
    updateMfaHeaderButton(session);
}

function logout() {
    sessionStorage.removeItem('toa_session');
    sessionStorage.removeItem('toa_google_token');
    pendingMfaUser = null;
    googleAccessToken = null;
    document.getElementById('portal').style.display = 'none';
    document.getElementById('mfa-screen').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('login-error').textContent = '';
}

// Auto-login if session exists
(function checkSession() {
    const session = getCurrentSession();
    if (session) showPortal(session);
})();

/* =======================================
   NAVIGATION TABS
   ======================================= */
document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');

        // Load admin users when admin tab is activated
        if (tab.dataset.tab === 'admin') {
            loadAdminUsers();
        }

        // Load meetings when meetings tab is activated
        if (tab.dataset.tab === 'meetings') {
            loadMeetings();
            updateGoogleMeetUI();
        }
    });
});

/* =======================================
   TEAM & SIGNATURES
   ======================================= */
let signaturesData = [];

async function loadSignatures() {
    const loading = document.getElementById('employee-loading');
    const select = document.getElementById('employee-select');
    loading.style.display = 'flex';

    try {
        const res = await fetch(`${API}/${CONFIG.SIGNATURES_TABLE}?fields%5B%5D=Signature+Name&fields%5B%5D=First+Name+(Single)+(from+Employee)&fields%5B%5D=Last+Name+(from+Employee)&fields%5B%5D=Phone+(from+Employee)&fields%5B%5D=Title+(from+Employee)&fields%5B%5D=LinkedIn+(from+Employee)&fields%5B%5D=Website&fields%5B%5D=Instagram&fields%5B%5D=HTML&fields%5B%5D=Preview+URL`, { headers });
        const data = await res.json();
        signaturesData = data.records || [];

        // Populate select
        select.innerHTML = '<option value="">Choose a person...</option>';
        signaturesData.forEach((rec, i) => {
            const name = rec.fields['Signature Name'] ||
                         `${(rec.fields['First Name (Single) (from Employee)'] || [''])[0]} ${(rec.fields['Last Name (from Employee)'] || [''])[0]}`.trim();
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = name;
            select.appendChild(opt);
        });
    } catch (err) {
        console.error('Failed to load signatures:', err);
    } finally {
        loading.style.display = 'none';
    }
}

document.getElementById('employee-select').addEventListener('change', (e) => {
    const idx = e.target.value;
    const detail = document.getElementById('employee-detail');
    const sigSection = document.getElementById('signature-section');

    if (idx === '') {
        detail.classList.remove('active');
        return;
    }

    const rec = signaturesData[idx];
    const f = rec.fields;

    const firstName = (f['First Name (Single) (from Employee)'] || ['\u2014'])[0];
    const lastName = (f['Last Name (from Employee)'] || ['\u2014'])[0];
    const phone = (f['Phone (from Employee)'] || ['\u2014'])[0];
    const title = (f['Title (from Employee)'] || ['\u2014'])[0];
    const linkedin = (f['LinkedIn (from Employee)'] || [''])[0];
    const website = f['Website'] || '';
    const instagram = f['Instagram'] || '';
    const html = f['HTML'] || '';
    const previewUrl = f['Preview URL'] || '';

    // Build info grid
    const grid = document.getElementById('employee-info-grid');
    grid.innerHTML = `
        <div class="info-card">
            <div class="info-label">Name</div>
            <div class="info-value">${firstName} ${lastName}</div>
        </div>
        <div class="info-card">
            <div class="info-label">Title</div>
            <div class="info-value">${title}</div>
        </div>
        <div class="info-card">
            <div class="info-label">Phone</div>
            <div class="info-value">${phone}</div>
        </div>
        <div class="info-card">
            <div class="info-label">LinkedIn</div>
            <div class="info-value">${linkedin ? `<a href="${linkedin}" target="_blank">${linkedin}</a>` : '\u2014'}</div>
        </div>
        <div class="info-card">
            <div class="info-label">Website</div>
            <div class="info-value">${website ? `<a href="${website}" target="_blank">${website}</a>` : '\u2014'}</div>
        </div>
        <div class="info-card">
            <div class="info-label">Instagram</div>
            <div class="info-value">${instagram ? `<a href="${instagram}" target="_blank">${instagram}</a>` : '\u2014'}</div>
        </div>
    `;

    // Signature section
    if (html) {
        sigSection.style.display = 'block';
        document.getElementById('signature-preview').innerHTML = html;
        const previewLink = document.getElementById('sig-preview-link');
        if (previewUrl) {
            previewLink.href = previewUrl;
            previewLink.style.display = 'inline-flex';
        } else {
            previewLink.style.display = 'none';
        }
    } else {
        sigSection.style.display = 'none';
    }

    detail.classList.add('active');
});

/* =======================================
   COPY SIGNATURE HTML
   ======================================= */
function copySignature() {
    const idx = document.getElementById('employee-select').value;
    if (idx === '') return;
    const html = signaturesData[idx].fields['HTML'] || '';
    navigator.clipboard.writeText(html).then(() => {
        showToast('Signature HTML copied to clipboard!');
    }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = html;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('Signature HTML copied to clipboard!');
    });
}

/* =======================================
   ADMIN - LOAD USERS
   ======================================= */
let allPortalUsers = [];

async function loadAdminUsers() {
    const loading = document.getElementById('admin-users-loading');
    const tbody = document.getElementById('admin-users-tbody');
    loading.style.display = 'flex';
    tbody.innerHTML = '';

    try {
        let allRecords = [];
        let offset = null;
        do {
            const url = offset
                ? `${API}/${CONFIG.USERS_TABLE}?offset=${offset}`
                : `${API}/${CONFIG.USERS_TABLE}`;
            const res = await fetch(url, { headers });
            const data = await res.json();
            allRecords = allRecords.concat(data.records || []);
            offset = data.offset || null;
        } while (offset);

        allPortalUsers = allRecords;

        tbody.innerHTML = '';
        allRecords.forEach(rec => {
            const f = rec.fields;
            const username = f['Username'] || '';
            const displayName = f['Display Name'] || '';
            const mobile = f['Mobile'] || '';
            const role = f['Role'] || 'User';
            const roleBadgeClass = role === 'Admin' ? 'admin' : 'user';
            const check = '<span class="perm-check">&#10003;</span>';
            const cross = '<span class="perm-cross">&#8212;</span>';

            const hasMfa = !!(f['MFA Secret']);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${escapeHtml(displayName)}</strong></td>
                <td>${escapeHtml(username)}</td>
                <td>${escapeHtml(mobile)}</td>
                <td><span class="role-badge ${roleBadgeClass}">${role}</span></td>
                <td>${f['Allow Forms'] ? check : cross}</td>
                <td>${f['Allow Team'] ? check : cross}</td>
                <td>${f['Allow Forecast'] ? check : cross}</td>
                <td>${f['Allow Runway'] ? check : cross}</td>
                <td>${f['Allow Clients'] ? check : cross}</td>
                <td>${hasMfa ? '<span class="perm-check">&#10003;</span>' : cross}</td>
                <td>
                    <button class="btn-edit" onclick="openEditModal('${rec.id}')">Edit</button>
                    ${hasMfa ? `<button class="btn-delete" onclick="resetUserMfa('${rec.id}', '${escapeHtml(username)}')" style="background:#f57c00;">Reset MFA</button>` : ''}
                    <button class="btn-delete" onclick="deleteUser('${rec.id}', '${escapeHtml(username)}')">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    } catch (err) {
        console.error('Failed to load users:', err);
        showToast('Failed to load users.');
    } finally {
        loading.style.display = 'none';
    }
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

/* =======================================
   ADMIN - CREATE USER
   ======================================= */
async function createUser() {
    const btn = document.getElementById('btn-create-user');
    const username = document.getElementById('new-username').value.trim();
    const password = document.getElementById('new-password').value;
    const displayName = document.getElementById('new-displayname').value.trim();
    const mobile = document.getElementById('new-mobile').value.trim();
    const role = document.getElementById('new-role').value;

    if (!username) { showToast('Email address is required.'); return; }
    if (password.length < 4) { showToast('Password must be at least 4 characters.'); return; }

    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
        // Check email uniqueness
        const checkFilter = encodeURIComponent(`{Username}="${username}"`);
        const checkRes = await fetch(`${API}/${CONFIG.USERS_TABLE}?filterByFormula=${checkFilter}`, { headers });
        const checkData = await checkRes.json();
        if (checkData.records && checkData.records.length > 0) {
            showToast('Email address already exists. Choose a different one.');
            return;
        }

        const fields = {
            'Username': username,
            'Password': password,
            'Display Name': displayName,
            'Mobile': mobile,
            'Role': role,
            'Allow Forms': document.getElementById('new-allow-forms').checked,
            'Allow Team': document.getElementById('new-allow-team').checked,
            'Allow Forecast': document.getElementById('new-allow-forecast').checked,
            'Allow Runway': document.getElementById('new-allow-runway').checked,
            'Allow Clients': document.getElementById('new-allow-clients').checked,
        };

        const res = await fetch(`${API}/${CONFIG.USERS_TABLE}`, {
            method: 'POST',
            headers: writeHeaders,
            body: JSON.stringify({ fields })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Failed to create user');
        }

        // Store created user info for success modal
        lastCreatedUser = {
            email: username,
            password: password,
            displayName: displayName,
            mobile: mobile,
        };

        // Show success modal
        document.getElementById('created-user-name').textContent = displayName || username;
        document.getElementById('created-user-info').textContent = `Account created for ${username}`;
        document.getElementById('btn-send-welcome-email').disabled = false;
        document.getElementById('btn-send-welcome-email').innerHTML = '&#9993; Send Welcome Email';
        document.getElementById('modal-user-created').classList.add('active');

        // Reset form
        document.getElementById('new-username').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('new-displayname').value = '';
        document.getElementById('new-mobile').value = '';
        document.getElementById('new-role').value = 'User';
        document.getElementById('new-allow-forms').checked = true;
        document.getElementById('new-allow-team').checked = true;
        document.getElementById('new-allow-forecast').checked = false;
        document.getElementById('new-allow-runway').checked = false;
        document.getElementById('new-allow-clients').checked = false;

        loadAdminUsers();
    } catch (err) {
        console.error('Create user error:', err);
        showToast('Error: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create User';
    }
}

/* =======================================
   ADMIN - EDIT USER MODAL
   ======================================= */
function openEditModal(recordId) {
    const rec = allPortalUsers.find(r => r.id === recordId);
    if (!rec) return;
    const f = rec.fields;

    document.getElementById('edit-record-id').value = recordId;
    document.getElementById('edit-username').value = f['Username'] || '';
    document.getElementById('edit-displayname').value = f['Display Name'] || '';
    document.getElementById('edit-mobile').value = f['Mobile'] || '';
    document.getElementById('edit-password').value = '';
    document.getElementById('edit-role').value = f['Role'] || 'User';
    document.getElementById('edit-allow-forms').checked = !!f['Allow Forms'];
    document.getElementById('edit-allow-team').checked = !!f['Allow Team'];
    document.getElementById('edit-allow-forecast').checked = !!f['Allow Forecast'];
    document.getElementById('edit-allow-runway').checked = !!f['Allow Runway'];
    document.getElementById('edit-allow-clients').checked = !!f['Allow Clients'];

    document.getElementById('modal-edit-user').classList.add('active');
}

function closeEditModal() {
    document.getElementById('modal-edit-user').classList.remove('active');
}

async function saveEditUser() {
    const btn = document.getElementById('btn-save-edit');
    const recordId = document.getElementById('edit-record-id').value;
    const newPassword = document.getElementById('edit-password').value;
    const newRole = document.getElementById('edit-role').value;

    // Safety: cannot demote last admin
    const currentRec = allPortalUsers.find(r => r.id === recordId);
    if (currentRec && currentRec.fields['Role'] === 'Admin' && newRole !== 'Admin') {
        const adminCount = allPortalUsers.filter(r => r.fields['Role'] === 'Admin').length;
        if (adminCount <= 1) {
            showToast('Cannot demote the last admin.');
            return;
        }
    }

    if (newPassword && newPassword.length < 4) {
        showToast('Password must be at least 4 characters.');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        const newDisplayName = document.getElementById('edit-displayname').value.trim();
        const newMobile = document.getElementById('edit-mobile').value.trim();

        const fields = {
            'Display Name': newDisplayName,
            'Mobile': newMobile,
            'Role': newRole,
            'Allow Forms': document.getElementById('edit-allow-forms').checked,
            'Allow Team': document.getElementById('edit-allow-team').checked,
            'Allow Forecast': document.getElementById('edit-allow-forecast').checked,
            'Allow Runway': document.getElementById('edit-allow-runway').checked,
            'Allow Clients': document.getElementById('edit-allow-clients').checked,
        };

        if (newPassword) {
            fields['Password'] = newPassword;
        }

        const res = await fetch(`${API}/${CONFIG.USERS_TABLE}/${recordId}`, {
            method: 'PATCH',
            headers: writeHeaders,
            body: JSON.stringify({ fields })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Failed to update user');
        }

        showToast('User updated successfully.');
        closeEditModal();

        // If we edited ourselves, update session and header
        const session = getCurrentSession();
        if (session && session.recordId === recordId) {
            session.role = newRole;
            session.displayName = newDisplayName;
            session.permissions = {
                forms: document.getElementById('edit-allow-forms').checked,
                team: document.getElementById('edit-allow-team').checked,
                forecast: document.getElementById('edit-allow-forecast').checked,
                runway: document.getElementById('edit-allow-runway').checked,
                clients: document.getElementById('edit-allow-clients').checked,
            };
            sessionStorage.setItem('toa_session', JSON.stringify(session));
            document.getElementById('user-badge').textContent = `Signed in as ${session.displayName || session.username}`;
        }

        loadAdminUsers();
    } catch (err) {
        console.error('Edit user error:', err);
        showToast('Error: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Save Changes';
    }
}

/* =======================================
   ADMIN - DELETE USER
   ======================================= */
async function deleteUser(recordId, username) {
    const session = getCurrentSession();

    // Cannot delete yourself
    if (session && session.recordId === recordId) {
        showToast('You cannot delete your own account.');
        return;
    }

    // Cannot delete last admin
    const targetRec = allPortalUsers.find(r => r.id === recordId);
    if (targetRec && targetRec.fields['Role'] === 'Admin') {
        const adminCount = allPortalUsers.filter(r => r.fields['Role'] === 'Admin').length;
        if (adminCount <= 1) {
            showToast('Cannot delete the last admin account.');
            return;
        }
    }

    if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
        return;
    }

    try {
        const res = await fetch(`${API}/${CONFIG.USERS_TABLE}/${recordId}`, {
            method: 'DELETE',
            headers: writeHeaders
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Failed to delete user');
        }

        showToast(`User "${username}" deleted.`);
        loadAdminUsers();
    } catch (err) {
        console.error('Delete user error:', err);
        showToast('Error: ' + err.message);
    }
}

/* =======================================
   CHANGE PASSWORD (SELF-SERVICE)
   ======================================= */
function openChangePasswordModal() {
    document.getElementById('pw-current').value = '';
    document.getElementById('pw-new').value = '';
    document.getElementById('pw-confirm').value = '';
    document.getElementById('modal-change-pw').classList.add('active');
}

function closeChangePasswordModal() {
    document.getElementById('modal-change-pw').classList.remove('active');
}

async function saveChangePassword() {
    const btn = document.getElementById('btn-save-pw');
    const currentPw = document.getElementById('pw-current').value;
    const newPw = document.getElementById('pw-new').value;
    const confirmPw = document.getElementById('pw-confirm').value;
    const session = getCurrentSession();

    if (!session) { showToast('Session not found. Please sign in again.'); return; }
    if (!currentPw) { showToast('Enter your current password.'); return; }
    if (newPw.length < 4) { showToast('New password must be at least 4 characters.'); return; }
    if (newPw !== confirmPw) { showToast('New passwords do not match.'); return; }

    btn.disabled = true;
    btn.textContent = 'Updating...';

    try {
        // Verify current password
        const filter = encodeURIComponent(`AND({Username}="${session.username}",{Password}="${currentPw}")`);
        const checkRes = await fetch(`${API}/${CONFIG.USERS_TABLE}?filterByFormula=${filter}`, { headers });
        const checkData = await checkRes.json();

        if (!checkData.records || checkData.records.length === 0) {
            showToast('Current password is incorrect.');
            return;
        }

        // Update password
        const res = await fetch(`${API}/${CONFIG.USERS_TABLE}/${session.recordId}`, {
            method: 'PATCH',
            headers: writeHeaders,
            body: JSON.stringify({ fields: { 'Password': newPw } })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Failed to update password');
        }

        showToast('Password updated successfully.');
        closeChangePasswordModal();
    } catch (err) {
        console.error('Change password error:', err);
        showToast('Error: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Update Password';
    }
}

/* =======================================
   MFA - VERIFICATION (LOGIN)
   ======================================= */
function showMfaVerification() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('mfa-screen').style.display = 'flex';
    document.getElementById('mfa-code').value = '';
    document.getElementById('mfa-error').textContent = '';
    setTimeout(() => document.getElementById('mfa-code').focus(), 100);
}

function cancelMfa() {
    pendingMfaUser = null;
    document.getElementById('mfa-screen').style.display = 'none';
    document.getElementById('login-screen').style.display = 'flex';
}

document.getElementById('mfa-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const code = document.getElementById('mfa-code').value.trim();
    const errorEl = document.getElementById('mfa-error');
    const btn = document.getElementById('mfa-btn');

    if (!pendingMfaUser) {
        errorEl.textContent = 'Session expired. Please sign in again.';
        return;
    }

    if (!/^\d{6}$/.test(code)) {
        errorEl.textContent = 'Enter a valid 6-digit code.';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Verifying...';
    errorEl.textContent = '';

    try {
        const totp = new OTPAuth.TOTP({
            issuer: 'MYTOA Portal',
            label: pendingMfaUser.record.fields['Username'] || '',
            algorithm: 'SHA1',
            digits: 6,
            period: 30,
            secret: OTPAuth.Secret.fromBase32(pendingMfaUser.secret)
        });

        const delta = totp.validate({ token: code, window: 1 });

        if (delta === null) {
            errorEl.textContent = 'Invalid code. Please try again.';
            return;
        }

        // Code valid  create session and proceed
        const session = buildSession(pendingMfaUser.record);
        sessionStorage.setItem('toa_session', JSON.stringify(session));
        pendingMfaUser = null;

        document.getElementById('mfa-screen').style.display = 'none';
        showPortal(session);
    } catch (err) {
        console.error('MFA verification error:', err);
        errorEl.textContent = 'Verification failed. Please try again.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Verify';
    }
});

/* =======================================
   MFA - SETUP
   ======================================= */
let mfaSetupSecret = null;

function updateMfaHeaderButton(session) {
    const btn = document.getElementById('btn-mfa-header');
    if (session.mfaEnabled) {
        btn.textContent = 'MFA: On';
        btn.style.borderColor = 'var(--toa-accent)';
    } else {
        btn.textContent = 'Set Up MFA';
        btn.style.borderColor = '';
    }
    btn.style.display = '';
}

function openMfaSettings() {
    const session = getCurrentSession();
    if (!session) return;

    if (typeof OTPAuth === 'undefined') {
        showToast('MFA library failed to load. Please refresh the page.');
        return;
    }

    if (session.mfaEnabled) {
        // Already enabled  offer to disable
        document.getElementById('mfa-disable-code').value = '';
        document.getElementById('mfa-disable-error').textContent = '';
        document.getElementById('modal-mfa-disable').classList.add('active');
    } else {
        // Not enabled  start setup
        startMfaSetup();
    }
}

function startMfaSetup() {
    const session = getCurrentSession();
    if (!session) return;

    // Generate a new TOTP secret
    const totp = new OTPAuth.TOTP({
        issuer: 'MYTOA Portal',
        label: session.username,
        algorithm: 'SHA1',
        digits: 6,
        period: 30,
        secret: new OTPAuth.Secret({ size: 20 })
    });

    mfaSetupSecret = totp.secret.base32;

    // Display the secret for manual entry
    document.getElementById('mfa-secret-display').textContent = mfaSetupSecret;

    // Generate QR code
    const otpauthUri = totp.toString();
    const canvas = document.getElementById('mfa-qr-canvas');
    QRCode.toCanvas(canvas, otpauthUri, { width: 200, margin: 2 }, function(error) {
        if (error) console.error('QR generation error:', error);
    });

    // Reset UI state
    document.getElementById('mfa-setup-code').value = '';
    document.getElementById('mfa-setup-error').textContent = '';
    document.getElementById('mfa-setup-step1').style.display = 'block';
    document.getElementById('mfa-setup-step2').style.display = 'none';

    document.getElementById('modal-mfa-setup').classList.add('active');
}

async function verifyMfaSetup() {
    const code = document.getElementById('mfa-setup-code').value.trim();
    const errorEl = document.getElementById('mfa-setup-error');
    const btn = document.getElementById('btn-verify-mfa-setup');

    if (!/^\d{6}$/.test(code)) {
        errorEl.textContent = 'Enter a valid 6-digit code.';
        return;
    }

    // Validate the code against the setup secret
    const totp = new OTPAuth.TOTP({
        issuer: 'MYTOA Portal',
        label: '',
        algorithm: 'SHA1',
        digits: 6,
        period: 30,
        secret: OTPAuth.Secret.fromBase32(mfaSetupSecret)
    });

    const delta = totp.validate({ token: code, window: 1 });

    if (delta === null) {
        errorEl.textContent = 'Invalid code. Make sure the code is current and try again.';
        return;
    }

    // Code is valid  save the secret to Airtable
    btn.disabled = true;
    btn.textContent = 'Enabling...';
    errorEl.textContent = '';

    try {
        const session = getCurrentSession();
        const res = await fetch(`${API}/${CONFIG.USERS_TABLE}/${session.recordId}`, {
            method: 'PATCH',
            headers: writeHeaders,
            body: JSON.stringify({ fields: { 'MFA Secret': mfaSetupSecret } })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Failed to enable MFA');
        }

        // Update local session
        session.mfaEnabled = true;
        sessionStorage.setItem('toa_session', JSON.stringify(session));
        updateMfaHeaderButton(session);

        // Show success step
        document.getElementById('mfa-setup-step1').style.display = 'none';
        document.getElementById('mfa-setup-step2').style.display = 'block';

        mfaSetupSecret = null;
        showToast('Two-factor authentication enabled.');
    } catch (err) {
        console.error('MFA setup error:', err);
        errorEl.textContent = 'Error: ' + err.message;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Enable MFA';
    }
}

function closeMfaSetupModal() {
    document.getElementById('modal-mfa-setup').classList.remove('active');
    mfaSetupSecret = null;
}

/* =======================================
   MFA - DISABLE
   ======================================= */
async function confirmDisableMfa() {
    const code = document.getElementById('mfa-disable-code').value.trim();
    const errorEl = document.getElementById('mfa-disable-error');
    const btn = document.getElementById('btn-confirm-disable-mfa');
    const session = getCurrentSession();

    if (!session) return;

    if (!/^\d{6}$/.test(code)) {
        errorEl.textContent = 'Enter a valid 6-digit code.';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Disabling...';
    errorEl.textContent = '';

    try {
        // Fetch the current secret from Airtable to verify the code
        const res = await fetch(
            `${API}/${CONFIG.USERS_TABLE}/${session.recordId}`,
            { headers }
        );
        const data = await res.json();
        const secret = data.fields?.['MFA Secret'];

        if (!secret) {
            session.mfaEnabled = false;
            sessionStorage.setItem('toa_session', JSON.stringify(session));
            updateMfaHeaderButton(session);
            closeMfaDisableModal();
            showToast('MFA is already disabled.');
            return;
        }

        // Verify the code
        const totp = new OTPAuth.TOTP({
            issuer: 'MYTOA Portal',
            label: '',
            algorithm: 'SHA1',
            digits: 6,
            period: 30,
            secret: OTPAuth.Secret.fromBase32(secret)
        });

        const delta = totp.validate({ token: code, window: 1 });

        if (delta === null) {
            errorEl.textContent = 'Invalid code. Please try again.';
            return;
        }

        // Code valid  clear MFA secret in Airtable
        const clearRes = await fetch(`${API}/${CONFIG.USERS_TABLE}/${session.recordId}`, {
            method: 'PATCH',
            headers: writeHeaders,
            body: JSON.stringify({ fields: { 'MFA Secret': '' } })
        });

        if (!clearRes.ok) {
            throw new Error('Failed to disable MFA');
        }

        session.mfaEnabled = false;
        sessionStorage.setItem('toa_session', JSON.stringify(session));
        updateMfaHeaderButton(session);
        closeMfaDisableModal();
        showToast('Two-factor authentication has been disabled.');
    } catch (err) {
        console.error('MFA disable error:', err);
        errorEl.textContent = 'Error: ' + err.message;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Disable MFA';
    }
}

function closeMfaDisableModal() {
    document.getElementById('modal-mfa-disable').classList.remove('active');
}

/* =======================================
   ADMIN - RESET USER MFA
   ======================================= */
async function resetUserMfa(recordId, username) {
    if (!confirm(`Reset MFA for "${username}"? They will need to set up MFA again.`)) {
        return;
    }

    try {
        const res = await fetch(`${API}/${CONFIG.USERS_TABLE}/${recordId}`, {
            method: 'PATCH',
            headers: writeHeaders,
            body: JSON.stringify({ fields: { 'MFA Secret': '' } })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Failed to reset MFA');
        }

        showToast(`MFA reset for "${username}".`);
        loadAdminUsers();
    } catch (err) {
        console.error('MFA reset error:', err);
        showToast('Error: ' + err.message);
    }
}

/* =======================================
   MY MEETINGS - LOAD & DISPLAY
   ======================================= */
async function loadMeetings() {
    const session = getCurrentSession();
    if (!session) return;
    if (!CONFIG.MEETINGS_TABLE) {
        document.getElementById('meetings-empty').style.display = 'block';
        return;
    }

    const loading = document.getElementById('meetings-loading');
    const emptyState = document.getElementById('meetings-empty');
    const tableSection = document.getElementById('meetings-table-section');
    const tbody = document.getElementById('meetings-tbody');

    loading.style.display = 'flex';
    emptyState.style.display = 'none';
    tableSection.style.display = 'none';
    tbody.innerHTML = '';

    try {
        const filter = encodeURIComponent(`{User Email}="${session.username}"`);
        let allRecords = [];
        let offset = null;

        do {
            let url = `${API}/${CONFIG.MEETINGS_TABLE}?filterByFormula=${filter}&sort%5B0%5D%5Bfield%5D=Date&sort%5B0%5D%5Bdirection%5D=desc`;
            if (offset) url += `&offset=${offset}`;
            const res = await fetch(url, { headers });
            const data = await res.json();
            allRecords = allRecords.concat(data.records || []);
            offset = data.offset || null;
        } while (offset);

        meetingsData = allRecords;

        if (allRecords.length === 0) {
            emptyState.style.display = 'block';
        } else {
            tableSection.style.display = 'block';
            allRecords.forEach((rec, idx) => {
                const f = rec.fields;
                const date = f['Date'] || '';
                const title = f['Title'] || 'Untitled Meeting';
                const source = f['Source'] || 'Manual';
                const duration = f['Duration'] || '\u2014';

                const sourceClass = source === 'Google Meet' ? 'google-meet'
                    : source === 'Fyxer.ai' ? 'fyxer'
                    : source === 'Plaud' ? 'plaud'
                    : 'manual';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(date)}</td>
                    <td><strong>${escapeHtml(title)}</strong></td>
                    <td><span class="source-badge ${sourceClass}">${escapeHtml(source)}</span></td>
                    <td>${escapeHtml(duration)}</td>
                    <td>
                        <button class="btn-edit" onclick="viewTranscript(${idx})">View</button>
                        <button class="btn-delete" onclick="deleteMeeting('${rec.id}', '${escapeHtml(title)}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    } catch (err) {
        console.error('Failed to load meetings:', err);
        showToast('Failed to load meetings.');
        emptyState.style.display = 'block';
    } finally {
        loading.style.display = 'none';
    }
}

/* =======================================
   MY MEETINGS - VIEW TRANSCRIPT
   ======================================= */
function viewTranscript(idx) {
    const rec = meetingsData[idx];
    if (!rec) return;
    const f = rec.fields;

    document.getElementById('view-transcript-title').textContent = f['Title'] || 'Untitled Meeting';
    document.getElementById('view-transcript-date').textContent = f['Date'] || '\u2014';
    document.getElementById('view-transcript-source').textContent = f['Source'] || 'Manual';
    document.getElementById('view-transcript-duration').textContent = f['Duration'] || '\u2014';

    const participants = f['Participants'] || '';
    const participantsSection = document.getElementById('view-transcript-participants-section');
    if (participants) {
        document.getElementById('view-transcript-participants-value').textContent = participants;
        participantsSection.style.display = 'block';
    } else {
        participantsSection.style.display = 'none';
    }

    document.getElementById('view-transcript-content').textContent = f['Transcript'] || '(No transcript content)';
    document.getElementById('modal-view-transcript').classList.add('active');
}

function closeViewTranscriptModal() {
    document.getElementById('modal-view-transcript').classList.remove('active');
}

function copyTranscriptContent() {
    const content = document.getElementById('view-transcript-content').textContent;
    navigator.clipboard.writeText(content).then(() => {
        showToast('Transcript copied to clipboard!');
    }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = content;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('Transcript copied to clipboard!');
    });
}

/* =======================================
   MY MEETINGS - MANUAL UPLOAD
   ======================================= */
function openUploadTranscriptModal() {
    document.getElementById('transcript-title').value = '';
    document.getElementById('transcript-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('transcript-duration').value = '';
    document.getElementById('transcript-participants').value = '';
    document.getElementById('transcript-content').value = '';
    document.getElementById('modal-upload-transcript').classList.add('active');
}

function closeUploadTranscriptModal() {
    document.getElementById('modal-upload-transcript').classList.remove('active');
}

async function saveManualTranscript() {
    const btn = document.getElementById('btn-save-transcript');
    const session = getCurrentSession();
    if (!session) { showToast('Session expired. Please sign in again.'); return; }
    if (!CONFIG.MEETINGS_TABLE) { showToast('Meetings table is not configured.'); return; }

    const title = document.getElementById('transcript-title').value.trim();
    const date = document.getElementById('transcript-date').value;
    const duration = document.getElementById('transcript-duration').value.trim();
    const participants = document.getElementById('transcript-participants').value.trim();
    const content = document.getElementById('transcript-content').value.trim();

    if (!title) { showToast('Meeting title is required.'); return; }
    if (!date) { showToast('Meeting date is required.'); return; }
    if (!content) { showToast('Transcript content is required.'); return; }

    btn.disabled = true;
    btn.textContent = 'Saving...';

    try {
        const fields = {
            'Title': title,
            'Date': date,
            'Transcript': content,
            'Source': 'Manual',
            'User Email': session.username,
        };
        if (duration) fields['Duration'] = duration;
        if (participants) fields['Participants'] = participants;

        const res = await fetch(`${API}/${CONFIG.MEETINGS_TABLE}`, {
            method: 'POST',
            headers: writeHeaders,
            body: JSON.stringify({ fields })
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Failed to save transcript');
        }

        showToast('Transcript saved successfully.');
        closeUploadTranscriptModal();
        loadMeetings();
    } catch (err) {
        console.error('Save transcript error:', err);
        showToast('Error: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Save Transcript';
    }
}

/* =======================================
   MY MEETINGS - DELETE
   ======================================= */
async function deleteMeeting(recordId, title) {
    if (!confirm(`Delete transcript "${title}"? This cannot be undone.`)) return;

    try {
        const res = await fetch(`${API}/${CONFIG.MEETINGS_TABLE}/${recordId}`, {
            method: 'DELETE',
            headers: writeHeaders
        });

        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error?.message || 'Failed to delete transcript');
        }

        showToast(`Transcript "${title}" deleted.`);
        loadMeetings();
    } catch (err) {
        console.error('Delete meeting error:', err);
        showToast('Error: ' + err.message);
    }
}

/* =======================================
   MY MEETINGS - GOOGLE MEET OAUTH
   ======================================= */
function connectGoogleMeet() {
    if (!CONFIG.GOOGLE_CLIENT_ID) {
        showToast('Google OAuth is not configured yet. Set GOOGLE_CLIENT_ID in CONFIG.');
        return;
    }

    if (typeof google === 'undefined' || !google.accounts) {
        showToast('Google Identity Services failed to load. Please refresh.');
        return;
    }

    const tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CONFIG.GOOGLE_CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.readonly',
        callback: (response) => {
            if (response.error) {
                console.error('Google OAuth error:', response);
                showToast('Google sign-in failed: ' + (response.error_description || response.error));
                return;
            }
            googleAccessToken = response.access_token;
            sessionStorage.setItem('toa_google_token', googleAccessToken);
            updateGoogleMeetUI();
            showToast('Google Meet connected successfully!');
        },
    });

    tokenClient.requestAccessToken();
}

function disconnectGoogleMeet() {
    if (googleAccessToken && typeof google !== 'undefined' && google.accounts) {
        google.accounts.oauth2.revoke(googleAccessToken, () => {
            console.log('Google token revoked');
        });
    }
    googleAccessToken = null;
    sessionStorage.removeItem('toa_google_token');
    updateGoogleMeetUI();
    showToast('Google Meet disconnected.');
}

function updateGoogleMeetUI() {
    const statusEl = document.getElementById('google-meet-status');
    const btnConnect = document.getElementById('btn-connect-google');
    const btnSync = document.getElementById('btn-sync-google');

    if (!statusEl || !btnConnect) return;

    if (googleAccessToken) {
        statusEl.textContent = 'Connected';
        statusEl.classList.add('connected');
        btnConnect.textContent = 'Disconnect';
        btnConnect.classList.add('connected');
        btnConnect.onclick = disconnectGoogleMeet;
        if (btnSync) btnSync.style.display = '';
    } else {
        statusEl.textContent = 'Not connected';
        statusEl.classList.remove('connected');
        btnConnect.textContent = 'Connect';
        btnConnect.classList.remove('connected');
        btnConnect.onclick = connectGoogleMeet;
        if (btnSync) btnSync.style.display = 'none';
    }
}

/* =======================================
   MY MEETINGS - GOOGLE MEET SYNC
   ======================================= */
async function syncGoogleMeetTranscripts() {
    if (!googleAccessToken) {
        showToast('Please connect Google Meet first.');
        return;
    }
    if (!CONFIG.MEETINGS_TABLE) {
        showToast('Meetings table is not configured.');
        return;
    }

    const btn = document.getElementById('btn-sync-google');
    const session = getCurrentSession();
    if (!session) return;

    btn.disabled = true;
    btn.textContent = 'Syncing...';

    try {
        // Search for Google Meet transcript docs in Drive
        const query = encodeURIComponent(
            "mimeType='application/vnd.google-apps.document' and (name contains 'Transcript' or name contains 'Meeting transcript')"
        );
        const driveRes = await fetch(
            `https://www.googleapis.com/drive/v3/files?q=${query}&fields=files(id,name,createdTime,modifiedTime)&orderBy=modifiedTime desc&pageSize=50`,
            { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
        );

        if (driveRes.status === 401) {
            googleAccessToken = null;
            sessionStorage.removeItem('toa_google_token');
            updateGoogleMeetUI();
            showToast('Google session expired. Please reconnect.');
            return;
        }

        const driveData = await driveRes.json();
        const files = driveData.files || [];

        if (files.length === 0) {
            showToast('No Google Meet transcripts found in your Drive.');
            return;
        }

        // Get existing external IDs to avoid duplicates
        const existingFilter = encodeURIComponent(
            `AND({User Email}="${session.username}", {Source}="Google Meet")`
        );
        const existingRes = await fetch(
            `${API}/${CONFIG.MEETINGS_TABLE}?filterByFormula=${existingFilter}&fields%5B%5D=External+ID`,
            { headers }
        );
        const existingData = await existingRes.json();
        const existingIds = new Set(
            (existingData.records || []).map(r => r.fields['External ID']).filter(Boolean)
        );

        let imported = 0;

        for (const file of files) {
            if (existingIds.has(file.id)) continue;

            // Export the Google Doc as plain text
            const exportRes = await fetch(
                `https://www.googleapis.com/drive/v3/files/${file.id}/export?mimeType=text/plain`,
                { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
            );

            if (!exportRes.ok) {
                console.warn(`Failed to export file ${file.id}:`, exportRes.status);
                continue;
            }

            let transcriptText = await exportRes.text();
            // Truncate if exceeds Airtable limit (100k chars)
            if (transcriptText.length > 99000) {
                transcriptText = transcriptText.substring(0, 99000) + '\n\n[Transcript truncated due to length]';
            }

            const fileDate = (file.createdTime || '').split('T')[0] || '';

            const fields = {
                'Title': file.name,
                'Date': fileDate,
                'Transcript': transcriptText,
                'Source': 'Google Meet',
                'User Email': session.username,
                'External ID': file.id,
            };

            const saveRes = await fetch(`${API}/${CONFIG.MEETINGS_TABLE}`, {
                method: 'POST',
                headers: writeHeaders,
                body: JSON.stringify({ fields })
            });

            if (saveRes.ok) imported++;
        }

        if (imported > 0) {
            showToast(`Imported ${imported} new transcript${imported > 1 ? 's' : ''} from Google Meet.`);
            loadMeetings();
        } else {
            showToast('All Google Meet transcripts are already imported.');
        }
    } catch (err) {
        console.error('Sync Google Meet error:', err);
        showToast('Sync failed: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '&#128260; Sync from Google Meet';
    }
}

/* =======================================
   USER CREATED MODAL - NOTIFICATIONS
   ======================================= */
function closeUserCreatedModal() {
    document.getElementById('modal-user-created').classList.remove('active');
    lastCreatedUser = null;
}

async function sendWelcomeEmail() {
    if (!lastCreatedUser) { showToast('No user data available.'); return; }

    const btn = document.getElementById('btn-send-welcome-email');

    if (!CONFIG.EMAILJS_PUBLIC_KEY || !CONFIG.EMAILJS_SERVICE_ID || !CONFIG.EMAILJS_TEMPLATE_ID) {
        showToast('EmailJS is not configured yet. Add keys in CONFIG.');
        return;
    }

    if (typeof emailjs === 'undefined') {
        showToast('EmailJS SDK failed to load.');
        return;
    }

    btn.disabled = true;
    btn.innerHTML = 'Sending...';

    try {
        await emailjs.send(CONFIG.EMAILJS_SERVICE_ID, CONFIG.EMAILJS_TEMPLATE_ID, {
            email: lastCreatedUser.email,
            to_name: lastCreatedUser.displayName || lastCreatedUser.email,
            portal_url: CONFIG.PORTAL_URL,
            user_email: lastCreatedUser.email,
        });
        btn.innerHTML = '&#10003; Email Sent';
        showToast('Welcome email sent successfully!');
    } catch (err) {
        console.error('EmailJS error:', err);
        btn.disabled = false;
        btn.innerHTML = '&#9993; Send Welcome Email';
        showToast('Failed to send email: ' + (err.text || err.message || 'Unknown error'));
    }
}

function sendWhatsAppPassword() {
    if (!lastCreatedUser) { showToast('No user data available.'); return; }

    if (!lastCreatedUser.mobile) {
        showToast('No mobile number provided for this user.');
        return;
    }

    // Strip non-digit characters from mobile number
    const phone = lastCreatedUser.mobile.replace(/[^0-9]/g, '');

    const message = `Hi ${lastCreatedUser.displayName || 'there'}!\n\nYour MYTOA Portal account has been created.\n\nLogin: ${lastCreatedUser.email}\nPassword: ${lastCreatedUser.password}\nPortal: ${CONFIG.PORTAL_URL}\n\nPlease change your password after first login.`;

    const waUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
    window.open(waUrl, '_blank');
}

/* =======================================
   MODAL GLOBAL HANDLERS (Escape & Overlay)
   ======================================= */
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (document.getElementById('modal-edit-user').classList.contains('active')) {
            closeEditModal();
        }
        if (document.getElementById('modal-change-pw').classList.contains('active')) {
            closeChangePasswordModal();
        }
        if (document.getElementById('modal-user-created').classList.contains('active')) {
            closeUserCreatedModal();
        }
        if (document.getElementById('modal-mfa-setup').classList.contains('active')) {
            closeMfaSetupModal();
        }
        if (document.getElementById('modal-mfa-disable').classList.contains('active')) {
            closeMfaDisableModal();
        }
        if (document.getElementById('modal-upload-transcript').classList.contains('active')) {
            closeUploadTranscriptModal();
        }
        if (document.getElementById('modal-view-transcript').classList.contains('active')) {
            closeViewTranscriptModal();
        }
    }
});

document.getElementById('modal-edit-user').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-edit-user')) {
        closeEditModal();
    }
});

document.getElementById('modal-change-pw').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-change-pw')) {
        closeChangePasswordModal();
    }
});

document.getElementById('modal-user-created').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-user-created')) {
        closeUserCreatedModal();
    }
});

document.getElementById('modal-mfa-setup').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-mfa-setup')) {
        closeMfaSetupModal();
    }
});

document.getElementById('modal-mfa-disable').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-mfa-disable')) {
        closeMfaDisableModal();
    }
});

document.getElementById('modal-upload-transcript').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-upload-transcript')) {
        closeUploadTranscriptModal();
    }
});

document.getElementById('modal-view-transcript').addEventListener('click', (e) => {
    if (e.target === document.getElementById('modal-view-transcript')) {
        closeViewTranscriptModal();
    }
});

/* =======================================
   TOAST
   ======================================= */
function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}
</script>

</body>
</html>
